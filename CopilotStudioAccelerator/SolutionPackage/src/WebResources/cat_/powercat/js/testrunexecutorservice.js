(()=>{var t={d:(e,o)=>{for(var i in o)t.o(o,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:o[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{TestRunExecutorService:()=>u});const o={STATE_KEY:"agent_auth_state",POSSIBLE_CHARS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",STATE_LENGTH:32,CODE_VERIFIER_LENGTH:64,AUTH_WINDOW_WIDTH:600,AUTH_WINDOW_HEIGHT:600,POLL_INTERVAL:100,AUTH_TIMEOUT:3e5,WIDTH:600,HEIGHT:600},i={PROGRESS:{id:"TESTRUN_ACTION_NOTIFICATION",message:"Test Run execution is in progress.",type:"INFO"},WARNING:{id:"TESTRUN_WARNING_NOTIFICATION",type:"WARNING"},ERROR:{id:"TESTRUN_ONSAVE_NOTIFICATION",type:"ERROR"}},r=7e3,n=200,a={NO_AUTH:1,ENTRA_ID_V2:2,MICROSOFT_AUTHENTICATION:3};var s=function(t,e,o,i){return new(o||(o=Promise))((function(r,n){function a(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(a,s)}c((i=i.apply(t,e||[])).next())}))};class c{constructor(t,e,o,i){this.clientId=t,this.tenantId=e,this.scopes=[o],this.clientUrl=i}generateRandomString(t){const e=o.POSSIBLE_CHARS,i=new Array(t);for(let o=0;o<t;o++){let t;do{t=crypto.getRandomValues(new Uint8Array(1))[0]}while(t>=Math.floor(256/e.length)*e.length);i[o]=e[t%e.length]}return i.join("")}generateCodeChallenge(t){return s(this,void 0,void 0,(function*(){const e=(new TextEncoder).encode(t),o=yield window.crypto.subtle.digest("SHA-256",e);return btoa(String.fromCharCode(...new Uint8Array(o))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}))}validateAuthResponse(t,e){return s(this,void 0,void 0,(function*(){const i=sessionStorage.getItem(o.STATE_KEY);if(!i)throw new Error("No stored state found");const{state:r}=JSON.parse(i);if(!t||!e)throw new Error("Authorization code or state missing from response");if(e!==r)throw new Error("State mismatch - possible CSRF attack");return t}))}getAuthorizationCode(){return s(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{try{const i=this.generateRandomString(o.STATE_LENGTH),r=this.generateRandomString(o.CODE_VERIFIER_LENGTH);sessionStorage.setItem(o.STATE_KEY,JSON.stringify({state:i,codeVerifier:r,timestamp:Date.now()})),this.generateCodeChallenge(r).then((r=>{const n=new URLSearchParams({client_id:this.clientId,response_type:"code",redirect_uri:this.clientUrl,scope:this.scopes.join(" "),state:i,code_challenge:r,code_challenge_method:"S256",prompt:"login",response_mode:"fragment"}),a=`https://login.microsoftonline.com/${this.tenantId}/oauth2/v2.0/authorize?${n.toString()}`,{WIDTH:s,HEIGHT:c}=o,d=window.screen.width/2-s/2,u=window.screen.height/2-c/2,l=window.open(a,"Login",`width=${s},height=${c},left=${d},top=${u},menubar=no,toolbar=no,location=no,status=no`);if(!l)return void e(new Error("Popup window was blocked. Please allow popups for this site."));let h;const f=()=>{clearInterval(h),l.closed||l.close()};h=window.setInterval((()=>{try{if(l.closed)return f(),void t({authCode:null,codeVerifier:null});if(l.location.href.includes("#")){f();const e=new URLSearchParams(l.location.hash.substring(1)),i=e.get("code"),r=e.get("state");i&&r?this.validateAuthResponse(i,r).then((e=>{if(e){const i=sessionStorage.getItem(o.STATE_KEY),{codeVerifier:r}=i?JSON.parse(i):{codeVerifier:null};t({authCode:e,codeVerifier:r})}else t({authCode:null,codeVerifier:null})})):t({authCode:null,codeVerifier:null})}}catch(t){t instanceof Error&&t.message.includes("cross-origin")||(f(),e(new Error(`Error polling auth window: ${t}`)))}}),o.POLL_INTERVAL),setTimeout((()=>{f(),t({authCode:null,codeVerifier:null})}),o.AUTH_TIMEOUT)}))}catch(t){e(t)}}))}))}}var d=function(t,e,o,i){return new(o||(o=Promise))((function(r,n){function a(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(a,s)}c((i=i.apply(t,e||[])).next())}))};class u{constructor(t,e,o,i,r){this.formContext=r,this.authService=new c(t,e,o,i)}waitForRecordId(){return d(this,arguments,void 0,(function*(t=r,e=n){let o=this.formContext.data.entity.getId(),i=0;const a=t/e;for(;!o&&i<a;)yield new Promise((t=>setTimeout(t,e))),o=this.formContext.data.entity.getId(),i++;return o?o.replace(/[{},]/g,""):null}))}removeNotification(t){setTimeout((()=>{this.formContext.ui.clearFormNotification(t)}),12e3)}invokeDataverseAction(t,e,o,r){return d(this,void 0,void 0,(function*(){try{const n=this.formContext.getAttribute("cat_copilottestsetid").getValue()[0].id.replace(/[{},]/g,""),a={entityType:this.formContext.data.entity.getEntityName(),id:yield this.waitForRecordId()},s={entity:a,AuthCode:e,CodeVerifier:o,CopilotConfigurationId:t,CopilotTestRunId:a.id,CopilotTestSetId:n,getMetadata:()=>({boundParameter:"entity",parameterTypes:{entity:{typeName:"mscrm.cat_copilottestrun",structuralProperty:5},AuthCode:{typeName:"Edm.String",structuralProperty:1},CodeVerifier:{typeName:"Edm.String",structuralProperty:1},CopilotConfigurationId:{typeName:"Edm.String",structuralProperty:1},CopilotTestRunId:{typeName:"Edm.String",structuralProperty:1},CopilotTestSetId:{typeName:"Edm.String",structuralProperty:1}},operationType:0,operationName:"cat_RunCopilotTests"})};if(!(yield Xrm.WebApi.online.execute(s)).ok)throw new Error("Failed to execute the action.");{const{PROGRESS:t,WARNING:e}=i;this.formContext.ui.setFormNotification(t.message,t.type,t.id),this.removeNotification(t.id),r&&(this.formContext.ui.setFormNotification(r,e.type,e.id),this.removeNotification(e.id))}}catch(t){throw new Error(`Failed to execute the action. Error Message: ${t instanceof Error?t.message:"Unknown error"}`)}}))}executeTestWithMicrosoftAuth(){return d(this,void 0,void 0,(function*(){try{const t=yield this.waitForRecordId();if(!t)throw new Error("Unable to get record ID");const e={pageType:"custom",name:"cat_agenttestrunner_18503",entityName:this.formContext.data.entity.getEntityName(),recordId:t},o={target:2,position:2,height:{value:100,unit:"%"},width:{value:40,unit:"%"},title:"Agent Test Runner"};yield Xrm.Navigation.navigateTo(e,o).then((()=>{this.formContext.data.refresh(!0)}))}catch(t){throw this.formContext.ui.setFormNotification("Error opening Agent Test Runner page: "+(t instanceof Error?t.message:"Unknown error"),"ERROR","AGENT_TEST_RUNNER_ERROR"),setTimeout((()=>{this.formContext.ui.clearFormNotification("AGENT_TEST_RUNNER_ERROR")}),8e3),t}}))}static onSave(t){return d(this,void 0,void 0,(function*(){if(!t)return;const e=t.getFormContext();if(1===e.ui.getFormType())try{const t=Xrm.Utility.getGlobalContext().getClientUrl(),o=e.getAttribute("cat_copilotconfigurationid").getValue()[0].id.replace(/[{},]/g,""),i=yield Xrm.WebApi.retrieveRecord("cat_copilotconfiguration",o,"?$select=cat_clientid,cat_tenantid,cat_userauthenticationcode,cat_scope"),r=new u(i.cat_clientid,i.cat_tenantid,i.cat_scope,t,e);let n={authCode:null,codeVerifier:null},s="";if(i.cat_userauthenticationcode===a.ENTRA_ID_V2){if(n=yield r.authService.getAuthorizationCode(),!n.authCode||!n.codeVerifier)throw new Error("Failed to obtain authorization code or code verifier");s="This agent configuration is configured with end-user authentication, which relies on Entra ID tokens with a limited lifetime. Consider splitting your test set if it takes longer than an hour to complete."}const c=i.cat_userauthenticationcode;if(-1!==[a.ENTRA_ID_V2,a.NO_AUTH].indexOf(c))yield r.invokeDataverseAction(o,n.authCode,n.codeVerifier,s);else{if(c!==a.MICROSOFT_AUTHENTICATION)throw new Error(`Unsupported authentication type: ${c}. Please check the Agent Configuration.`);yield r.executeTestWithMicrosoftAuth()}}catch(t){const{ERROR:o}=i;e.ui.setFormNotification(`An error occurred while running the test. Please check the Agent Configuration. ${t instanceof Error?t.message:"Unknown error"}`,o.type,o.id),u.prototype.removeNotification(o.id)}}))}}window.onSave=u.onSave})();var o=cat="undefined"==typeof cat?{}:cat;for(var i in e)o[i]=e[i];e.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})})();