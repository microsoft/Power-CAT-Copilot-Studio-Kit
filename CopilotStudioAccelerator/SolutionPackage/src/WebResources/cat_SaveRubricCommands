var RubricRefinement = RubricRefinement || {};

(function () {
    "use strict";

    var CONFIG = {
        customPageName: "cat_rubricrefinement_af389",
        entityLogicalName: "cat_copilottestresult"
    };

    // ========================================================================
    // OPEN RUBRIC REFINEMENT DIALOG - From Subgrid Command
    // ========================================================================
    
    this.openRubricRefinementDialog = function (selectedItemIds, selectedControl) {
        "use strict";
        
        try {
            var selectedRecordIds = [];
            
            if (selectedItemIds && selectedItemIds.length > 0) {
                for (var i = 0; i < selectedItemIds. length; i++) {
                    var id = selectedItemIds[i]. replace(/[{}]/g, "");
                    selectedRecordIds.push(id);
                }
            }
            
            if (selectedRecordIds.length === 0 && selectedControl && selectedControl.getGrid) {
                try {
                    var grid = selectedControl.getGrid();
                    var rows = grid.getRows();
                    rows.forEach(function(row) {
                        var entity = row.getData().getEntity();
                        var id = entity.getId().replace(/[{}]/g, "");
                        selectedRecordIds.push(id);
                    });
                } catch (e) {}
            }
            
            if (selectedRecordIds.length > 0) {
                fetchRecordDetails(selectedRecordIds[0]).then(function(details) {
                    openCustomPage(selectedRecordIds, details.testRunId, details.rubricId, selectedControl);
                }).catch(function(error) {
                    openCustomPage(selectedRecordIds, "", "", selectedControl);
                });
            } else {
                Xrm.Navigation.openAlertDialog({
                    text: "No records found to process.",
                    title: "Refine Rubric"
                });
            }
            
        } catch (error) {
            Xrm.Navigation.openErrorDialog({
                message: "Error opening Refine Rubric dialog: " + error.message
            });
        }
    };

    // ========================================================================
    // FETCH RECORD DETAILS
    // ========================================================================
    
    function fetchRecordDetails(recordId) {
        return new Promise(function(resolve, reject) {
            Xrm.WebApi.retrieveRecord(
                CONFIG.entityLogicalName,
                recordId,
                "?$select=_cat_copilottestrunid_value,_cat_rubricid_value"
            ).then(
                function success(result) {
                    resolve({
                        testRunId: result._cat_copilottestrunid_value || "",
                        rubricId: result._cat_rubricid_value || ""
                    });
                },
                function error(e) {
                    reject(e);
                }
            );
        });
    }

    // ========================================================================
    // OPEN CUSTOM PAGE
    // ========================================================================
    
    function openCustomPage(selectedRecordIds, testRunId, rubricId, selectedControl) {
        try {
            sessionStorage.setItem("RubricRefinement_Records", JSON.stringify(selectedRecordIds));
            sessionStorage.setItem("RubricRefinement_TestRunId", testRunId);
            sessionStorage. setItem("RubricRefinement_RubricId", rubricId);
        } catch(e) {}
        
        var dataParam = selectedRecordIds. join(",") + "|" + testRunId + "|" + rubricId;
        var pageInput = {
            pageType:  "custom",
            name: CONFIG.customPageName,
            recordId: dataParam
        };
        
        var navigationOptions = {
            target: 2,
            position:  1,
            height: 290,
            width: 400,
            title: "Refine Rubric"
        };
        
        Xrm.Navigation.navigateTo(pageInput, navigationOptions).then(
            function success() {
                // Clear sessionStorage after dialog closes
                clearSessionStorage();
                
                // Refresh the main form
                refreshMainForm(selectedControl);
            }
        ).catch(function(error) {
            Xrm.Navigation. openErrorDialog({
                message:  "Error opening Refine Rubric dialog:  " + error.message
            });
        });
    }

    // ========================================================================
    // CLEAR SESSION STORAGE
    // ========================================================================
    
    function clearSessionStorage() {
        try {
            sessionStorage.removeItem("RubricRefinement_Records");
            sessionStorage.removeItem("RubricRefinement_TestRunId");
            sessionStorage.removeItem("RubricRefinement_RubricId");
        } catch (e) {
            console.error("Error clearing sessionStorage: " + e.message);
        }
    }

    // ========================================================================
    // REFRESH MAIN FORM
    // ========================================================================
    
    function refreshMainForm(selectedControl) {
        try {
            var formContext = getFormContext(selectedControl);
            if (formContext && formContext.data && formContext. data.refresh) {
                formContext.data.refresh(true).catch(function(e) {
                    console.error("Error refreshing form: " + e.message);
                });
                return;
            }

            //Fallback - Refresh the subgrid only
            if (selectedControl && selectedControl.refresh) {
                selectedControl.refresh();
            }

        } catch (e) {
            console.error("Error refreshing main form: " + e.message);
            
            // Fallback: Try to refresh subgrid
            try {
                if (selectedControl && selectedControl.refresh) {
                    selectedControl. refresh();
                }
            } catch (ex) {
                console.error("Error refreshing subgrid: " + ex.message);
            }
        }
    }

    // ========================================================================
    // GET FORM CONTEXT FROM SELECTED CONTROL
    // ========================================================================
    
    function getFormContext(selectedControl) {
        try {
            // Method 1: From subgrid's parent form
            if (selectedControl && selectedControl.getParentForm) {
                return selectedControl.getParentForm();
            }

            // Method 2: Try to get from parent
            if (selectedControl && selectedControl._controlDescriptor && 
                selectedControl._controlDescriptor.formContext) {
                return selectedControl._controlDescriptor.formContext;
            }

            return null;
        } catch (e) {
            console.error("Error getting form context: " + e.message);
            return null;
        }
    }

    // ========================================================================
    // ENABLE RULES
    // ========================================================================
    
    this.enableRefineRubricButton = function () {
        return true;
    };

}).call(RubricRefinement);