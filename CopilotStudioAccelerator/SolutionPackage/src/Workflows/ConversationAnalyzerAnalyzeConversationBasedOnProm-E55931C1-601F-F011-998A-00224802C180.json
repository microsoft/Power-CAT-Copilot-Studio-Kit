{
  "properties": {
    "connectionReferences": {
      "shared_commondataserviceforapps": {
        "api": {
          "name": "shared_commondataserviceforapps"
        },
        "connection": {
          "connectionReferenceLogicalName": "cat_CopilotStudioAcceleratorDataverse"
        },
        "runtimeSource": "embedded"
      }
    },
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$authentication": {
          "defaultValue": {},
          "type": "SecureObject"
        },
        "$connections": {
          "defaultValue": {},
          "type": "Object"
        },
        "Power Automate Region (cat_PowerAutomateEndpoint)": {
          "defaultValue": "Commercial",
          "type": "String",
          "metadata": {
            "schemaName": "cat_PowerAutomateEndpoint",
            "description": "Specify your Power Automate environment region/cloud: Commercial, GCC, GCC High, or DoD."
          }
        }
      },
      "triggers": {
        "manual": {
          "type": "Request",
          "kind": "PowerAppV2",
          "inputs": {
            "schema": {
              "type": "object",
              "properties": {
                "text": {
                  "title": "AgentId",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Agent Id",
                  "x-ms-content-hint": "TEXT"
                },
                "text_1": {
                  "title": "EnvironmentUrl",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Dataverse Environment Url",
                  "x-ms-content-hint": "TEXT"
                },
                "text_2": {
                  "title": "PromptId",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Conversation Analyzer Prompt Id",
                  "x-ms-content-hint": "TEXT"
                },
                "text_3": {
                  "title": "PromptName",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Conversation Analyzer Prompt Name",
                  "x-ms-content-hint": "TEXT"
                },
                "text_4": {
                  "title": "UserPrompt",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "User Prompt",
                  "x-ms-content-hint": "TEXT"
                },
                "text_5": {
                  "title": "SelectedConversation",
                  "type": "string",
                  "x-ms-dynamically-added": true,
                  "description": "Selected Conversation",
                  "x-ms-content-hint": "TEXT"
                }
              },
              "required": [
                "text",
                "text_1",
                "text_2",
                "text_3",
                "text_5"
              ]
            }
          },
          "metadata": {
            "operationMetadataId": "e0ee10b9-7363-4ca1-ad44-2b36f2bed559"
          }
        }
      },
      "actions": {
        "Scope:_Try": {
          "type": "Scope",
          "actions": {
            "Scope:_Delete_existing_records": {
              "type": "Scope",
              "actions": {
                "List_rows:_Conversation_Analyzer": {
                  "type": "OpenApiConnection",
                  "inputs": {
                    "parameters": {
                      "entityName": "cat_conversationanalyzers",
                      "$select": "cat_conversationanalyzerid",
                      "$filter": "cat_agentid eq '@{triggerBody()['text']}' and _cat_prompt_value eq '@{triggerBody()['text_2']}'"
                    },
                    "host": {
                      "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                      "operationId": "ListRecords",
                      "connectionName": "shared_commondataserviceforapps"
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "cc0b03ff-e778-4fd5-bba7-0465b177d9ae"
                  }
                },
                "Apply_to_each:_Conversation_Analyzer": {
                  "type": "Foreach",
                  "foreach": "@outputs('List_rows:_Conversation_Analyzer')?['body/value']",
                  "actions": {
                    "Delete_a_row:_Delete_existing_Conversation_Analyzer_records": {
                      "type": "OpenApiConnection",
                      "inputs": {
                        "parameters": {
                          "entityName": "cat_conversationanalyzers",
                          "recordId": "@items('Apply_to_each:_Conversation_Analyzer')?['cat_conversationanalyzerid']"
                        },
                        "host": {
                          "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                          "operationId": "DeleteRecord",
                          "connectionName": "shared_commondataserviceforapps"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "bad0e6fb-7c2e-4d10-8cf7-a6fba8a0e4cc"
                      }
                    }
                  },
                  "runAfter": {
                    "List_rows:_Conversation_Analyzer": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 20
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "892e2eec-f76b-4c7b-90ac-8e65bb12e25d"
                  }
                }
              },
              "runAfter": {
                "Add_a_new_row:_Logs": [
                  "SUCCEEDED"
                ]
              },
              "metadata": {
                "operationMetadataId": "3d408a09-110b-4c27-906a-4083d4f24f41"
              }
            },
            "Scope_:_Execute_Selected_Conversation_Analyser_Prompt_": {
              "type": "Scope",
              "actions": {
                "Parse_JSON_:_Selected_Conversation": {
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@triggerBody()['text_5']",
                    "schema": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "content": {
                            "type": "string"
                          },
                          "conversationduration": {
                            "type": "integer"
                          },
                          "conversationtranscriptid": {
                            "type": "string"
                          },
                          "createdon": {
                            "type": "string"
                          },
                          "message": {
                            "type": "string"
                          },
                          "messagecount": {
                            "type": "string"
                          },
                          "name": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "content",
                          "conversationduration",
                          "conversationtranscriptid",
                          "createdon",
                          "message",
                          "messagecount",
                          "name"
                        ]
                      }
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "0aa38649-0158-417a-9bcc-249bbd3df412"
                  }
                },
                "Apply_to_each_-_Selected_Conversation": {
                  "type": "Foreach",
                  "foreach": "@body('Parse_JSON_:_Selected_Conversation')",
                  "actions": {
                    "Switch": {
                      "type": "Switch",
                      "expression": "@triggerBody()['text_3']",
                      "default": {
                        "actions": {
                          "Run_a_prompt_Custom_User_Prompt": {
                            "type": "OpenApiConnection",
                            "inputs": {
                              "parameters": {
                                "recordId": "a80ccc4d-28a4-4a10-8196-4bc71f6b76fc",
                                "item/requestv2/UserPrompt": "@triggerBody()?['text_4']",
                                "item/requestv2/AgentConversation": "@items('Apply_to_each_-_Selected_Conversation')['message']"
                              },
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "operationId": "aibuilderpredict_customprompt",
                                "connectionName": "shared_commondataserviceforapps"
                              }
                            },
                            "metadata": {
                              "operationMetadataId": "3e649c06-f7a2-42e8-bba1-08de75ae7a1f",
                              "flowSystemMetadata": {
                                "portalOperationId": "aibuilderpredict_customprompt",
                                "portalOperationGroup": "aibuilder",
                                "portalOperationApiDisplayNameOverride": "AI Builder",
                                "portalOperationIconOverride": "https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/aiBuilderNew.51dbdb6b.png",
                                "portalOperationBrandColorOverride": "#0A76C4",
                                "portalOperationApiTierOverride": "Standard"
                              }
                            }
                          },
                          "Compose_:_Custom_User_Prompt_Error_Response": {
                            "type": "Compose",
                            "inputs": {
                              "result": "NA",
                              "convSummary": "Unable to evaluate due to sensitive or unsupported content."
                            },
                            "runAfter": {
                              "Run_a_prompt_Custom_User_Prompt": [
                                "Failed",
                                "TimedOut"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "89efd874-491e-4747-afe2-7f04f049928b"
                            }
                          },
                          "Parse_JSON_Custom_User_Prompt": {
                            "type": "ParseJson",
                            "inputs": {
                              "content": "@outputs('Run_a_prompt_Custom_User_Prompt')?['body/responsev2/predictionOutput/text']",
                              "schema": {
                                "type": "object",
                                "properties": {
                                  "result": {
                                    "type": "string"
                                  },
                                  "convSummary": {
                                    "type": "string"
                                  }
                                }
                              }
                            },
                            "runAfter": {
                              "Compose_:_Custom_User_Prompt_Error_Response": [
                                "Skipped"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "f8591550-3b40-40f1-9dff-36379e7ed233"
                            }
                          },
                          "Add_a_new_row_:_Conversation_Analyzer_for_Custom_Prompt__": {
                            "type": "OpenApiConnection",
                            "inputs": {
                              "parameters": {
                                "entityName": "cat_conversationanalyzers",
                                "item/cat_name": "@items('Apply_to_each_-_Selected_Conversation')['name']",
                                "item/cat_messages": "@items('Apply_to_each_-_Selected_Conversation')['messagecount']",
                                "item/cat_agentid": "@triggerBody()['text']",
                                "item/cat_content": "@items('Apply_to_each_-_Selected_Conversation')['content']",
                                "item/cat_conversationdurationseconds": "@items('Apply_to_each_-_Selected_Conversation')['conversationduration']",
                                "item/cat_conversationid": "@items('Apply_to_each_-_Selected_Conversation')['conversationtranscriptid']",
                                "item/cat_Prompt@odata.bind": "cat_conversationanalyzerprompts(@{triggerBody()['text_2']})",
                                "item/cat_promptresult": "@coalesce(outputs('Run_a_prompt_Custom_User_Prompt')?['body/responsev2/predictionOutput/text'],outputs('Compose_:_Custom_User_Prompt_Error_Response'))",
                                "item/cat_summary": "@coalesce(outputs('Run_a_prompt_Custom_User_Prompt')?['body/responsev2/predictionOutput/structuredOutput/convSummary'],'Unable to evaluate due to sensitive or unsupported content.')"
                              },
                              "host": {
                                "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                "operationId": "CreateRecord",
                                "connectionName": "shared_commondataserviceforapps"
                              }
                            },
                            "runAfter": {
                              "Parse_JSON_Custom_User_Prompt": [
                                "Succeeded",
                                "Skipped"
                              ]
                            },
                            "metadata": {
                              "operationMetadataId": "3f23abda-9578-42ad-b998-93dcb00a2cee"
                            }
                          }
                        }
                      },
                      "cases": {
                        "Case_1": {
                          "actions": {
                            "Run_a_prompt_PII_Analysis": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "recordId": "fd7e5beb-7b6c-434e-8491-730de80bdb60",
                                  "item/requestv2/AgentConversation": "@items('Apply_to_each_-_Selected_Conversation')['message']"
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "aibuilderpredict_customprompt",
                                  "connectionName": "shared_commondataserviceforapps"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "d820ea8a-90e8-4fd9-895c-d481d7fad44c",
                                "flowSystemMetadata": {
                                  "portalOperationId": "aibuilderpredict_customprompt",
                                  "portalOperationGroup": "aibuilder",
                                  "portalOperationApiDisplayNameOverride": "AI Builder",
                                  "portalOperationIconOverride": "https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/aiBuilderNew.51dbdb6b.png",
                                  "portalOperationBrandColorOverride": "#0A76C4",
                                  "portalOperationApiTierOverride": "Standard"
                                }
                              }
                            },
                            "Compose_:_PII_Error_Message": {
                              "type": "Compose",
                              "inputs": {
                                "summary": {
                                  "totalPIIItems": "NA",
                                  "containsPII": false,
                                  "highestSeverity": "0",
                                  "convSummary": "Unable to evaluate due to sensitive or unsupported content."
                                },
                                "pii": []
                              },
                              "runAfter": {
                                "Run_a_prompt_PII_Analysis": [
                                  "Failed",
                                  "TimedOut"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "ecc0e782-c036-4adf-99ee-fea094713cb9"
                              }
                            },
                            "Parse_JSON_:_PII_Message": {
                              "type": "ParseJson",
                              "inputs": {
                                "content": "@outputs('Run_a_prompt_PII_Analysis')?['body/responsev2/predictionOutput/text']",
                                "schema": {
                                  "type": "object",
                                  "properties": {
                                    "summary": {
                                      "type": "object",
                                      "properties": {
                                        "totalPIIItems": {
                                          "type": "string"
                                        },
                                        "containsPII": {
                                          "type": "boolean"
                                        },
                                        "highestSeverity": {
                                          "type": "string"
                                        },
                                        "convSummary": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "pii": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "type": {
                                            "type": "string"
                                          },
                                          "value": {
                                            "type": "string"
                                          },
                                          "message": {
                                            "type": "string"
                                          },
                                          "confidencescore": {
                                            "type": "string"
                                          },
                                          "severity": {
                                            "type": "string"
                                          }
                                        },
                                        "required": [
                                          "type",
                                          "value",
                                          "message",
                                          "confidencescore",
                                          "severity"
                                        ]
                                      }
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Compose_:_PII_Error_Message": [
                                  "Skipped"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "94a4eaba-7991-4d4a-981e-d378b86a559d"
                              }
                            },
                            "Add_a_new_row_:_Conversation_Analyzer_for_PII": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "entityName": "cat_conversationanalyzers",
                                  "item/cat_name": "@items('Apply_to_each_-_Selected_Conversation')['name']",
                                  "item/cat_messages": "@items('Apply_to_each_-_Selected_Conversation')['messagecount']",
                                  "item/cat_agentid": "@triggerBody()['text']",
                                  "item/cat_content": "@items('Apply_to_each_-_Selected_Conversation')['content']",
                                  "item/cat_conversationdurationseconds": "@items('Apply_to_each_-_Selected_Conversation')['conversationduration']",
                                  "item/cat_conversationid": "@items('Apply_to_each_-_Selected_Conversation')['conversationtranscriptid']",
                                  "item/cat_Prompt@odata.bind": "cat_conversationanalyzerprompts(@{triggerBody()['text_2']})",
                                  "item/cat_promptresult": "@coalesce(outputs('Run_a_prompt_PII_Analysis')?['body/responsev2/predictionOutput/text'],outputs('Compose_:_PII_Error_Message'))",
                                  "item/cat_summary": "@coalesce(outputs('Run_a_prompt_PII_Analysis')?['body/responsev2/predictionOutput/structuredOutput/summary/convSummary'],'Unable to evaluate due to sensitive or unsupported content.')"
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "CreateRecord",
                                  "connectionName": "shared_commondataserviceforapps"
                                }
                              },
                              "runAfter": {
                                "Parse_JSON_:_PII_Message": [
                                  "Succeeded",
                                  "Skipped"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "0ca64714-8b77-4870-aae2-7d63e0049196"
                              }
                            }
                          },
                          "case": "PII Analysis"
                        },
                        "Case_2": {
                          "actions": {
                            "Run_a_prompt_Sentiment_Analysis": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "recordId": "44930ac1-d6b5-41a1-b369-e7d7d89f1918",
                                  "item/requestv2/AgentConversation": "@items('Apply_to_each_-_Selected_Conversation')['message']"
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "aibuilderpredict_customprompt",
                                  "connectionName": "shared_commondataserviceforapps"
                                }
                              },
                              "metadata": {
                                "operationMetadataId": "a39c4bef-de4c-4b1d-adcc-cd831a15ed31",
                                "flowSystemMetadata": {
                                  "portalOperationId": "aibuilderpredict_customprompt",
                                  "portalOperationGroup": "aibuilder",
                                  "portalOperationApiDisplayNameOverride": "AI Builder",
                                  "portalOperationIconOverride": "https://content.powerapps.com/resource/makerx/static/pauto/images/designeroperations/aiBuilderNew.51dbdb6b.png",
                                  "portalOperationBrandColorOverride": "#0A76C4",
                                  "portalOperationApiTierOverride": "Standard"
                                }
                              }
                            },
                            "Compose_:_Sentiment_Error_Response": {
                              "type": "Compose",
                              "inputs": {
                                "summary": {
                                  "overallSentiment": "NA",
                                  "dominantEmotion": "Mixed",
                                  "averageSentimentScore": "0",
                                  "convSummary": "Unable to evaluate due to sensitive or unsupported content."
                                },
                                "sentiments": []
                              },
                              "runAfter": {
                                "Run_a_prompt_Sentiment_Analysis": [
                                  "Failed",
                                  "TimedOut"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "b78547b9-6439-41a8-bcb8-7f081c1f8c29"
                              }
                            },
                            "Parse_JSON_Sentiment_Response": {
                              "type": "ParseJson",
                              "inputs": {
                                "content": "@outputs('Run_a_prompt_Sentiment_Analysis')?['body/responsev2/predictionOutput/text']",
                                "schema": {
                                  "type": "object",
                                  "properties": {
                                    "summary": {
                                      "type": "object",
                                      "properties": {
                                        "overallSentiment": {
                                          "type": "string"
                                        },
                                        "dominantEmotion": {
                                          "type": "string"
                                        },
                                        "averageSentimentScore": {
                                          "type": "string"
                                        },
                                        "convSummary": {
                                          "type": "string"
                                        }
                                      }
                                    },
                                    "sentiments": {
                                      "type": "array",
                                      "items": {
                                        "type": "object",
                                        "properties": {
                                          "sentiment": {
                                            "type": "string"
                                          },
                                          "sentimentScore": {
                                            "type": "string"
                                          },
                                          "emotion": {
                                            "type": "string"
                                          },
                                          "emotionIntensity": {
                                            "type": "string"
                                          },
                                          "sentimentVariability": {
                                            "type": "string"
                                          },
                                          "summary": {
                                            "type": "string"
                                          },
                                          "confidenceScore": {
                                            "type": "string"
                                          },
                                          "message": {
                                            "type": "string"
                                          }
                                        },
                                        "required": [
                                          "sentiment",
                                          "sentimentScore",
                                          "emotion",
                                          "emotionIntensity",
                                          "sentimentVariability",
                                          "summary",
                                          "confidenceScore",
                                          "message"
                                        ]
                                      }
                                    }
                                  }
                                }
                              },
                              "runAfter": {
                                "Compose_:_Sentiment_Error_Response": [
                                  "Skipped"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "c2791ff8-bca8-4549-9f62-7aa057c9bdb3"
                              }
                            },
                            "Add_a_new_row_:_Conversation_Analyzer_for_Sentiment": {
                              "type": "OpenApiConnection",
                              "inputs": {
                                "parameters": {
                                  "entityName": "cat_conversationanalyzers",
                                  "item/cat_name": "@items('Apply_to_each_-_Selected_Conversation')['name']",
                                  "item/cat_messages": "@items('Apply_to_each_-_Selected_Conversation')['messagecount']",
                                  "item/cat_agentid": "@triggerBody()['text']",
                                  "item/cat_content": "@items('Apply_to_each_-_Selected_Conversation')['content']",
                                  "item/cat_conversationdurationseconds": "@items('Apply_to_each_-_Selected_Conversation')['conversationduration']",
                                  "item/cat_conversationid": "@items('Apply_to_each_-_Selected_Conversation')['conversationtranscriptid']",
                                  "item/cat_Prompt@odata.bind": "cat_conversationanalyzerprompts(@{triggerBody()['text_2']})",
                                  "item/cat_promptresult": "@coalesce(outputs('Run_a_prompt_Sentiment_Analysis')?['body/responsev2/predictionOutput/text'],outputs('Compose_:_Sentiment_Error_Response'))",
                                  "item/cat_summary": "@coalesce(outputs('Run_a_prompt_Sentiment_Analysis')?['body/responsev2/predictionOutput/structuredOutput/summary/convSummary'],'Unable to evaluate due to sensitive or unsupported content.')"
                                },
                                "host": {
                                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                                  "operationId": "CreateRecord",
                                  "connectionName": "shared_commondataserviceforapps"
                                }
                              },
                              "runAfter": {
                                "Parse_JSON_Sentiment_Response": [
                                  "Succeeded",
                                  "Skipped"
                                ]
                              },
                              "metadata": {
                                "operationMetadataId": "590ddbb8-b717-4329-9298-f3263e3e2087"
                              }
                            }
                          },
                          "case": "Sentiment Analysis"
                        }
                      },
                      "metadata": {
                        "operationMetadataId": "4f803c9c-4297-4243-9fa6-bb9b5461d21d"
                      }
                    }
                  },
                  "runAfter": {
                    "Parse_JSON_:_Selected_Conversation": [
                      "Succeeded"
                    ]
                  },
                  "runtimeConfiguration": {
                    "concurrency": {
                      "repetitions": 20
                    }
                  },
                  "metadata": {
                    "operationMetadataId": "5dee24cb-b106-4bae-9621-e405f8619345"
                  }
                }
              },
              "runAfter": {
                "Scope:_Delete_existing_records": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "0ff20e8f-9c83-457b-9b78-9c0e73f19a89"
              }
            },
            "Get_Flow_Endpoint": {
              "type": "Compose",
              "inputs": "@if(equals(toLower(parameters('Power Automate Region (cat_PowerAutomateEndpoint)')), 'gcc'), 'https://make.gov.powerautomate.us/', \r\n    if(equals(toLower(parameters('Power Automate Region (cat_PowerAutomateEndpoint)')), 'gcc(high)'), 'https://make.high.powerautomate.us/', \r\n        if(equals(toLower(parameters('Power Automate Region (cat_PowerAutomateEndpoint)')), 'dod'), 'https://make.powerautomate.appsplatform.us/', \r\n            'https://make.powerautomate.com/'\r\n        )\r\n    )\r\n)",
              "metadata": {
                "operationMetadataId": "dc8e743d-1408-445c-8614-ee97abfcad5e"
              }
            },
            "Add_a_new_row:_Logs": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "cat_copilotstudiokitlogses",
                  "item/cat_executionstatuscode": 2,
                  "item/cat_cloudflowinstanceurl": "@{outputs('Get_Flow_Endpoint')}environments/@{workflow()?['tags']?['environmentName']}/solutions/fd140aaf-4df4-11dd-bd17-0019b9312238/flows/@{workflow()?['name']}/runs/@{workflow()?['run']?['name']}",
                  "item/cat_cloudflowname": "Conversation Analyzer | Analyze Conversation Based On Prompt"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "CreateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "runAfter": {
                "Get_Flow_Endpoint": [
                  "SUCCEEDED"
                ]
              },
              "metadata": {
                "operationMetadataId": "1743ccd2-b8bb-4cee-9823-870ee9d4d438"
              }
            }
          },
          "runAfter": {
            "Initialize_variable:_ErrorMessage": [
              "Succeeded"
            ]
          },
          "metadata": {
            "operationMetadataId": "eba63fed-d86f-4381-920d-caa1753220a8"
          }
        },
        "Scope:_Catch": {
          "type": "Scope",
          "actions": {
            "Filter_array:_Error_Actions": {
              "type": "Query",
              "inputs": {
                "from": "@result('Scope:_Try')",
                "where": "@or(equals(item()?['Status'], 'Failed'), equals(item()?['Status'], 'TimedOut'))"
              },
              "metadata": {
                "operationMetadataId": "318aa9b2-4531-451c-b162-84cf7a4a236e"
              }
            },
            "Set_variable:_ErrorMessage": {
              "type": "SetVariable",
              "inputs": {
                "name": "ErrorMessage",
                "value": "@{first(body('Filter_array:_Error_Actions'))?['error']?['message']}"
              },
              "runAfter": {
                "Filter_array:_Error_Actions": [
                  "Succeeded"
                ]
              },
              "metadata": {
                "operationMetadataId": "ee38e0e1-03cd-48d8-9933-d73f7204b0f7"
              }
            }
          },
          "runAfter": {
            "Scope:_Try": [
              "Failed",
              "Skipped",
              "TimedOut"
            ]
          },
          "metadata": {
            "operationMetadataId": "a89e7d5d-22c3-46df-ab6f-e51181e86e6e"
          }
        },
        "Initialize_variable:_ErrorMessage": {
          "type": "InitializeVariable",
          "inputs": {
            "variables": [
              {
                "name": "ErrorMessage",
                "type": "string"
              }
            ]
          },
          "runAfter": {},
          "metadata": {
            "operationMetadataId": "84dc8095-fa63-4f71-aaa9-ed2863a636bb"
          }
        },
        "Scope:_Finally": {
          "type": "Scope",
          "actions": {
            "Respond_to_a_Power_App_or_flow": {
              "type": "Response",
              "kind": "PowerApp",
              "inputs": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errormessage": {
                      "title": "ErrorMessage",
                      "x-ms-dynamically-added": true,
                      "type": "string"
                    }
                  },
                  "additionalProperties": {}
                },
                "statusCode": 200,
                "body": {
                  "errormessage": "@variables('ErrorMessage')"
                }
              },
              "runAfter": {
                "Update_a_row:_Logs": [
                  "SUCCEEDED"
                ]
              },
              "metadata": {
                "operationMetadataId": "9b4ac5d7-ab46-4fe5-a0b9-572e5d1d7994"
              }
            },
            "Update_a_row:_Logs": {
              "type": "OpenApiConnection",
              "inputs": {
                "parameters": {
                  "entityName": "cat_copilotstudiokitlogses",
                  "recordId": "@outputs('Add_a_new_row:_Logs')?['body/cat_copilotstudiokitlogsid']",
                  "item/cat_executionstatuscode": "@if(not(empty(variables('ErrorMessage'))), 4, 3)",
                  "item/cat_errormessage": "@if(not(empty(variables('ErrorMessage'))), variables('ErrorMessage'), null)"
                },
                "host": {
                  "apiId": "/providers/Microsoft.PowerApps/apis/shared_commondataserviceforapps",
                  "operationId": "UpdateRecord",
                  "connectionName": "shared_commondataserviceforapps"
                }
              },
              "metadata": {
                "operationMetadataId": "9f447776-551f-41e3-a432-ecfb376e623f"
              }
            }
          },
          "runAfter": {
            "Scope:_Catch": [
              "Succeeded",
              "Failed",
              "Skipped",
              "TimedOut"
            ]
          },
          "metadata": {
            "operationMetadataId": "3b16a931-71ef-4a27-b6c8-cea6a9fc38f1"
          }
        }
      }
    },
    "templateName": null
  },
  "schemaVersion": "1.0.0.0"
}